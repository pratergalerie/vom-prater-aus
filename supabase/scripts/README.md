# Database Setup for Self-Hosted Supabase

This directory contains SQL scripts and initialization scripts for setting up the database schema and tables for a self-hosted Supabase instance.

## Files

- `initial_schema.sql`: Creates the database schema and tables.
- `initial_data.sql`: Inserts initial data into the tables. This file is generated by the `generate_initial_data.js` script, using data from the `intial-data` directory.
- `indexes_and_triggers.sql`: Creates indexes and triggers for the tables
- `create_storage_bucket.js`: Script to create a Supabase Storage bucket for website content
- `create_storage_bucket.sh`: Shell script to run the bucket creation script
- `upload_initial_images.js`: Script to upload initial images to the Supabase Storage bucket

## How It Works

The solution uses a custom entrypoint script (`custom-entrypoint.sh`) that:

1. Runs the original PostgreSQL entrypoint script in the background
2. Waits for the initial data SQL file to be created
3. Runs the database service
4. Runs the DB setup scripts to create the schema, insert data, and create indexes and triggers
5. The initial storage bucket is created by the `storage-bucket-setup` service
6. The initial images are uploaded to the storage bucket by the `upload_initial_images.js` script

## Storage Bucket Setup

The `create_storage_bucket.js` script creates a Supabase Storage bucket called `content-storage` if it doesn't already exist. This bucket is used to store website content such as images.

The script is run by the `storage-bucket-setup` service in the Docker Compose configuration, which:

1. Waits for the Supabase services to be ready
2. Installs the required dependencies
3. Runs the bucket creation script

## Usage

These scripts are automatically used by the Docker Compose configuration in the root directory. The `docker-compose.yml` file mounts these scripts to the PostgreSQL container and uses the custom entrypoint script.

## Modifying the Schema

If you need to modify the database schema, you can:

1. Update the SQL scripts in this directory
2. Restart the Docker containers with `docker-compose down` and `docker-compose up -d`

The initialization script will only run the SQL scripts if the tables don't already exist, so your data will be preserved.
