FROM node:22-alpine3.21

WORKDIR /workspace

# Copy package files first for better caching
COPY package*.json ./

# Install dependencies
RUN npm install

# Copy the rest of the application
COPY . .

# Create Nitro storage directory and set permissions
# To avoid "listen EADDRINUSE: address already in use /tmp/nitro/worker-X.sock" errors
RUN mkdir -p /tmp/nitro-storage && chmod 777 /tmp/nitro-storage

# Ensure Sharp is installed correctly
# To avoid "Something went wrong installing the "sharp" module. Cannot find module." errors
RUN rm -rf node_modules/sharp
RUN npm install --cpu=arm64 --os=linux --libc=musl sharp

# Expose the development port
EXPOSE 3000
EXPOSE 24678

# Start the development server with hot reload
CMD ["npm", "run", "dev"]
